(()=>{"use strict";const t=class{_array;_count;constructor(){this._array=[],this._count=0}get length(){return this._count}get capacity(){return this._array.length}clear(){this._array.fill(void 0),this._count=0}contains(t){for(let e=0;e<this._array.length;e++)if(this._array[e]==t)return!0;return!1}peek(){return this._array[this._count-1]}push(t){if(this._array.length==this._count)return this._array.push(t),void this._count++;this._array[this._count]=t,this._count++}pop(){if(0==this._count)throw new Error("Failed to pop from stack. Stack is empty.");this._count--;const t=this._array[this._count];return this._array[this._count]=void 0,t}shift(){if(0==this._count)throw new Error("Failed to shift from stack. Stack is empty.");this._count--;const t=this._array[0];for(let t=0;t<this._count;t++)this._array[t]=this._array[t+1];return this._array[this._count]=void 0,t}};class e{_pool;_type;constructor(e){this._type=e,this._pool=new t}get(){try{return this._pool.pop()}catch{return new this._type}}return(t){this._pool.push(t)}}const s=new Map;!function(t){t.sharedPoolFor=function(e){let i=s.get(e);return void 0===i&&(i=new t(e),s.set(e,i)),i}}(e||(e={}));const i=e;class n{r;g;b;constructor(t,e,s){this.r=0|t,this.g=0|e,this.b=0|s}copy(){return new n(this.r,this.g,this.b)}set(t){this.r=t.r,this.g=t.g,this.b=t.b}set3i(t,e,s){this.r=0|t,this.g=0|e,this.b=0|s}equals(t){return this.r==t.r&&this.g==t.g&&this.b==t.b}css(){return`rgb(${this.r},${this.g},${this.b})`}}const o=n;class a{#t=new Map;addObserver(t,e,s){let i=this.#t.get(e);i||(i=[],this.#t.set(e,i)),i.push({observer:t,callback:s})}removeObserver(t,e,s){return void 0===e?this.#e(t):void 0===s?this.#s(t,e):this.#i(t,e,s)}#e(t){let e=!1;for(let s of this.#t.keys())e=e||this.#s(t,s);return e}#s(t,e){const s=this.#t.get(e);if(!s)return!1;let i=!1;for(let e=0;e<s.length;e++)s[e].observer==t&&(i=!0,s.splice(e,1),e--);return i}#i(t,e,s){const i=this.#t.get(e);if(!i)return!1;for(let e=0;e<i.length;e++){const n=i[e];if(n.observer==t&&n.callback!=s)return i.splice(e,1),!0}return!1}notify(t,e){const s=this.#t.get(t);if(s)for(let t of s)t.callback.call(t.observer,e)}}function r(t,e,s){return t<e?e:t>s?s:t}const h="undefined"!=typeof chrome&&void 0===chrome.runtime;function l(t){return h?chrome.runtime.getURL(t):t}function c(t,e,s){const i=document.createElement("template");i.innerHTML=t;const n=i.content.firstElementChild;if(!(n instanceof HTMLElement))throw new Error("First element must be HTML element");return d(n,e,s),n}function d(t,e,s){for(let i of t.attributes){if(void 0!==s&&"name"==i.name)s[i.value]=t;else if(void 0!==e&&i.name.startsWith("data-on-")){const s=i.name.substring(8),n=i.value;if("function"!=typeof e[n])throw new Error(`[Discord Tegaki]Controller doesn't have ${n} method`);t.addEventListener(s,(function(t){return e[n](t)}))}if("src"==i.name&&i.value.match(/^\[.+\]$/)){const t=i.value.substring(1,i.value.length-1);i.value=l(t)}}let i;i=t instanceof HTMLTemplateElement?t.content.children:t.children;for(let t of i)t instanceof HTMLElement&&d(t,e,s);return t}function u(t){const e=t.getBoundingClientRect();e.x<0?t.style.left="0":e.right>window.innerWidth&&(t.style.left=window.innerWidth-t.clientWidth+"px"),e.y<0?t.style.top="0":e.bottom>window.innerHeight&&(t.style.top=window.innerHeight-t.clientHeight+"px")}const _=function(t){const e=document.createElement("template");e.innerHTML='<svg width="0px" height="0px" xmlns="http://www.w3.org/2000/svg" version="1.1">\r\n  <defs>\r\n    <filter id="tegaki-canvas-cursor-filter">\r\n      <feColorMatrix type="matrix" values="-255 0 0 0 127 0 -255 0 0 127 0 0 -255 0 127 0 0 0 1 0"/>\r\n    </filter>\r\n  </defs>\r\n</svg>\r\n';const s=e.content.firstElementChild;if(!(s instanceof SVGElement))throw new Error("First element must be SVG ELement");return s}();document.body.appendChild(_);const g={spoit:{x:1,y:14}};class v extends a{foreColor=new o(128,0,0);backgroundColor=new o(240,224,214);penMode="pen";_subTool="none";penSize=4;eraserSize=4;constructor(){super()}get subTool(){return this._subTool}set subTool(t){this._subTool!=t&&(this._subTool=t,this.notify("change-sub-tool",t))}}class p{canvas;context;constructor(t=100,e=100){this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=e;const s=this.canvas.getContext("2d");if(null==s)throw new Error("Failed to get OffscreenCanvasRenderingContext2D");this.context=s,this.context.lineCap="round",this.context.lineJoin="round"}copy(){const t=new p(this.width,this.height);return t.context.drawImage(this.canvas,0,0),t}get width(){return this.canvas.width}set width(t){this.canvas.width=t}get height(){return this.canvas.height}set height(t){this.canvas.height=t}}const m=class extends a{canvas;context;_state;_width;_height;_innerScale;_image;_offscreen;_scale=1;_mouseX=0;_mouseY=0;_isMouseEnter=!1;_isDrawing=!1;_drawingPath=[];_activePointerId=null;_needsRender=!1;_renderCallback;_undoStack=new t;_redoStack=new t;_spoitContext;constructor(t){super(),this._state=new v,this._width=t.width,this._height=t.height,this._innerScale=1,this._state.foreColor.set(t.foreColor),this._state.backgroundColor.set(t.backgroundColor),this._renderCallback=this.render.bind(this),this.canvas=document.createElement("canvas"),this.canvas.width=this.width,this.canvas.height=this.height,this._image=new p(this.innerWidth,this.innerHeight),this._offscreen=new p(this.innerWidth,this.innerHeight);const e=this.canvas.getContext("2d");if(null===e)throw new Error("Failed to get CanvasRendering2DContext");this.context=e;const s=document.createElement("canvas");s.width=1,s.height=1;const i=s.getContext("2d",{willReadFrequently:!0});if(null===i)throw new Error("Failed to get CanvasRendering2DContext");this._spoitContext=i,this.init()}get state(){return this._state}get width(){return this._width}get height(){return this._height}get innerScale(){return this._innerScale}get innerWidth(){return this.width*this._innerScale}get innerHeight(){return this.height*this._innerScale}get scale(){return this._scale}set scale(t){if(t<=0)throw new RangeError("Invalid Argument: scale must be greater than 0.");this.scale!=t&&(this._scale=t,this.canvas.width=this.width*this.scale,this.canvas.height=this.height*this.scale,this.requestRender(),this.notify("scale-changed",t))}get undoLength(){return this._undoStack.length}get redoLength(){return this._redoStack.length}get toolSize(){return"pen"==this._state.penMode?this._state.penSize:this._state.eraserSize}get isDrawing(){return this._isDrawing}download(){const t=document.createElement("a"),e=`tegaki-${Date.now()}.png`;t.setAttribute("download",e),t.setAttribute("href",this._image.canvas.toDataURL()),t.click()}copyToClipboard(){return new Promise(((t,e)=>{this._image.canvas.toBlob((s=>{if(null!=s)try{const e=`<img src="tegaki-${Date.now()}.png">`;navigator.clipboard.write([new ClipboardItem({"text/html":new Blob([e],{type:"text/html"}),"image/png":s})]),t()}catch(t){e(t)}else e(new Error("Failed to get blob from canvas"))}))}))}requestRender(){this._needsRender||(this._needsRender=!0,requestAnimationFrame(this._renderCallback))}render(){const t=this._offscreen.context;if(this._offscreen.width==this._image.width&&this._offscreen.height==this._image.height||(this._offscreen.width=this._image.width,this._offscreen.height=this._image.height),t.imageSmoothingEnabled=!1,t.drawImage(this._image.canvas,0,0),this.drawPath(t,this._drawingPath),this.context.save(),this.context.scale(this._scale/this._innerScale,this._scale/this._innerScale),this.context.imageSmoothingEnabled=!0,this.context.imageSmoothingQuality="high",this.context.drawImage(this._offscreen.canvas,0,0),this.context.restore(),"none"==this._state.subTool&&(this._isMouseEnter||this._isDrawing)){const t=this.toolSize,e=t%2==0?0:.5,s=t*this.scale,i=this.positionInCanvas(this._mouseX,this._mouseY);let n,o,a,r;i.x=(i.x+e)*this.scale|0,i.y=(i.y+e)*this.scale|0,this.context.save(),s>=8?(this.context.beginPath(),this.context.arc(i.x+e,i.y+e,s/2+1.1,0,2*Math.PI),this.context.arc(i.x+e,i.y+e,s/2+.4,0,2*Math.PI),this.context.clip("evenodd"),n=i.x-s/2-2,o=i.y-s/2-2,a=r=s+4):(this.context.beginPath(),this.context.rect(i.x,i.y,1,1),this.context.rect(i.x-9,i.y,5,1),this.context.rect(i.x+5,i.y,5,1),this.context.rect(i.x,i.y-9,1,5),this.context.rect(i.x,i.y+5,1,5),this.context.clip(),n=i.x-9,o=i.y-9,a=r=19),this.context.filter="url(#tegaki-canvas-cursor-filter)",this.context.imageSmoothingEnabled=!1,this.context.drawImage(this.canvas,n,o,a,r,n,o,a,r),this.context.restore()}this._needsRender=!1}init(){this.canvas.addEventListener("pointerdown",(t=>{"mouse"==t.pointerType&&0!=t.button||(null!=this._activePointerId&&(this.finishDraw(),this.canvas.releasePointerCapture(this._activePointerId)),this._activePointerId=t.pointerId,this.canvas.setPointerCapture(this._activePointerId),this._mouseX=t.clientX,this._mouseY=t.clientY,"spoit"==this._state.subTool?this.execSpoit():this.startDraw())})),this.canvas.addEventListener("pointermove",(t=>{if(null==this._activePointerId)return this._mouseX=t.clientX,this._mouseY=t.clientY,this._isMouseEnter=!0,this.requestRender(),!1;this._activePointerId==t.pointerId&&(this._mouseX=t.clientX,this._mouseY=t.clientY,this._isMouseEnter=!0,"spoit"==this._state.subTool?this.execSpoit():this._isDrawing?this.continueDraw():this.requestRender())})),this.canvas.addEventListener("pointerleave",(t=>{null==this._activePointerId&&(this._isMouseEnter=!1,this.requestRender())})),this.canvas.addEventListener("pointerup",(t=>{this._activePointerId==t.pointerId&&(this._isDrawing&&this.finishDraw(),this._activePointerId=null)})),this.canvas.addEventListener("pointercancel",(t=>{null!=this._activePointerId&&(this._isDrawing&&this.finishDraw(),this.canvas.releasePointerCapture(this._activePointerId),this._activePointerId=null)})),this._state.addObserver(this,"change-sub-tool",(t=>{if("none"==t)this.canvas.style.cursor="none";else{const e=g[t];this.canvas.style.cursor=`url(${l("asset/cursor-"+t+".cur")}) ${e.x} ${e.y}, auto`}this.notify("change-sub-tool",t),this.requestRender()})),this.clear(!1)}execSpoit(t,e){if(void 0===t||void 0===e){const s=this.positionInCanvas(this._mouseX,this._mouseY);t=s.x,e=s.y}if(e|=0,!((t|=0)<0||t>=this._image.width||e<0||e>=this._image.height))try{this._spoitContext.drawImage(this._image.canvas,t,e,1,1,0,0,1,1);const s=this._spoitContext.getImageData(0,0,1,1).data,i=new o(s[0],s[1],s[2]);"pen"==this._state.penMode?this._state.foreColor.set(i):this._state.backgroundColor.set(i),this.notify("spoit",{tool:this._state.penMode,color:i})}catch{}}fill(){this.addHistory(),this._image.context.fillStyle=this._state.foreColor.css(),this._image.context.fillRect(0,0,this._image.width,this._image.height),this.requestRender()}clear(t=!0){t&&this.addHistory(),this._image.context.fillStyle=this._state.backgroundColor.css(),this._image.context.fillRect(0,0,this._image.width,this._image.height),this.requestRender()}startDraw(){this._isDrawing&&this.finishDraw(),this._isDrawing=!0;const t=this.positionInCanvas(this._mouseX,this._mouseY);t.x=t.x,t.y=t.y,this.toolSize%2==1&&(t.x+=.5,t.y+=.5),this._drawingPath.push(t),this.requestRender()}continueDraw(){if(!this._isDrawing)return;const t=this.positionInCanvas(this._mouseX,this._mouseY);t.x=t.x,t.y=t.y,this.toolSize%2==1&&(t.x+=.5,t.y+=.5),this._drawingPath.push(t),this.requestRender()}finishDraw(){this._isDrawing&&0!=this._drawingPath.length&&(this.addHistory(),this.drawPath(this._image.context,this._drawingPath),this._isDrawing=!1,this._drawingPath.length=0,this.requestRender())}drawPath(t,e){if(0==e.length)return;t.save(),t.scale(this._innerScale,this._innerScale),t.lineCap="round",t.lineJoin="bevel","pen"==this._state.penMode?(t.strokeStyle=this._state.foreColor.css(),t.lineWidth=this._state.penSize):(t.strokeStyle=this._state.backgroundColor.css(),t.lineWidth=this._state.eraserSize),t.globalAlpha=.6,t.beginPath();const s=e[0];t.moveTo(s.x,s.y);for(let s=1;s<e.length;s++){const i=e[s];t.lineTo(i.x,i.y)}t.stroke(),t.globalAlpha=.94,t.lineWidth-=1==t.lineWidth?.4:1.4,t.beginPath(),t.moveTo(s.x,s.y);for(let s=1;s<e.length;s++){const i=e[s];t.lineTo(i.x,i.y)}t.stroke(),t.filter="none",t.fillStyle="#fff";for(let t of e);t.restore()}flip(){this.addHistory();const t=i.sharedPoolFor(p),e=this._image,s=t.get();s.width=e.width,s.height=e.height,s.context.save(),s.context.scale(-1,1),s.context.drawImage(e.canvas,-s.width,0),s.context.restore(),this._image=s,t.return(e),this.requestRender()}resize(t,e){if(e|=0,(t|=0)<1)throw new RangeError("width must be greater than 0");if(e<1)throw new RangeError("height must be greater than 0");this.addHistory();const s=i.sharedPoolFor(p),n=this._image,o=s.get();o.width=t*this.innerScale,o.height=e*this.innerScale,o.context.fillStyle=this._state.backgroundColor.css(),o.context.fillRect(0,0,o.width,o.height),o.context.drawImage(n.canvas,0,0),this._image=o,s.return(n),this._refrectImageSizeToCanvasSize(),this.requestRender()}undo(){if(0==this._undoStack.length)return;const t=this._undoStack.pop();this._redoStack.push(this._image),this._image=t,this._refrectImageSizeToCanvasSize(),this.requestRender(),this.notify("update-history",this)}redo(){if(0==this._redoStack.length)return;const t=this._redoStack.pop();this._undoStack.push(this._image),this._image=t,this._refrectImageSizeToCanvasSize(),this.requestRender(),this.notify("update-history",this)}_refrectImageSizeToCanvasSize(){const t=this._image.width/this.innerScale,e=this._image.height/this.innerScale;this._width==t&&this._height==e||(this._width=this._image.width/this.innerScale,this._height=this._image.height/this.innerScale,this.canvas.width=this._width*this._scale,this.canvas.height=this._height*this._scale,this.notify("size-changed",this))}addHistory(){const t=i.sharedPoolFor(p),e=t.get();if(e.width==this._image.width&&e.height==this._image.height||(e.width=this._image.width,e.height=this._image.height),e.context.drawImage(this._image.canvas,0,0),this._undoStack.push(e),this._undoStack.length>10){let e=this._undoStack.shift();t.return(e)}for(;this._redoStack.length>0;){let e=this._redoStack.pop();t.return(e)}this.notify("update-history",this)}positionInCanvas(t,e){const s=this.canvas.getBoundingClientRect();return{x:t=(t-s.x)*this.innerWidth/s.width|0,y:e=(e-s.y)*this.innerHeight/s.height|0}}};class w extends a{_value;constructor(t){super(),this._value=t}get value(){return this._value}set value(t){this._value!=t&&(this._value=t,this.notify("change",this._value))}sync(){this.notify("change",this._value)}}class b extends a{_value;constructor(t,e,s){super(),this._value=new o(t,e,s)}get value(){return this._value}set value(t){this._value.set(t),this.notify("change",this._value)}sync(){this.notify("change",this._value)}}const f=["r","g","b"];function y(t,e,s){return t<e?e:t>s?s:t}const C=class extends a{element;_outlets;_color;_palette;_blurCallback;constructor(t,e=255,s=255,i=255){super(),this._color=new o(255,255,255),this._outlets={},this.element=c('\n      <div class="color-picker" name="root" tabindex="-1">\n        <div class="content">\n          <div class="area-palette">\n            <ul name="colors" class="colors">\n            </ul>\n          </div>\n          <div class="area-picker">\n            <ul>\n              <li><div class="preview" name="preview"></div></li>\n              <li>\n                <span class="color-char">R:</span>\n                <input type="range" name="slider-r" min="0" max="255">\n                <input type="number" name="field-r" min="0" max="255">\n              </li>\n              <li>\n                <span class="color-char">G:</span>\n                <input type="range" name="slider-g" min="0" max="255">\n                <input type="number" name="field-g" min="0" max="255">\n              </li>\n              <li>\n                <span class="color-char">B:</span>\n                <input type="range" name="slider-b" min="0" max="255">\n                <input type="number" name="field-b" min="0" max="255">\n              </li>\n            </ul>\n          </div>\n        </div>\n      </div>\n    ',this,this._outlets),this._palette=[];const n=this._outlets.colors;for(let t=0;t<4;t++)for(let t=0;t<4;t++){const t=document.createElement("li");t.style.backgroundColor="#FFFFFF",n.appendChild(t);const e=new o(255,255,255);this._palette.push({element:t,color:e}),t.onclick=()=>{this.set(e),this.notify("change",this._color)}}t.appendChild(this.element),this._blurCallback=t=>{(function(t,e){for(;null!=t;){if(t==e)return!0;t=t.parentElement}return!1})(t.target,this.element)||this.close()},this.init(),this.render()}render(){for(const t of f){const e=this._outlets["slider-"+t],s=this._outlets["field-"+t],i=this._color[t].toString();e.value=i,s.value=i}this._outlets.preview.style.backgroundColor=this._color.css()}toggle(t,e){"block"==this.element.style.display?this.close():this.open(t,e)}open(t,e){const s=this.element;s.style.left=`${t}px`,s.style.top=`${e}px`,s.style.display="block",s.focus(),u(s),window.addEventListener("focusin",this._blurCallback)}close(){this._outlets.root.style.display="none",window.removeEventListener("focusin",this._blurCallback)}init(){this._outlets.root.addEventListener("keydown",(t=>{}));for(const t of f)for(const e of["slider","field"]){const s=this._outlets[e+"-"+t];s.addEventListener("input",(e=>{this._color[t]=parseInt(s.value),this._color[t]=y(this._color[t],0,255),this.render()})),s.addEventListener("wheel",(e=>{e.preventDefault(),this._color[t]+=e.deltaY>0?-1:1,this._color[t]=y(this._color[t],0,255),this.render(),this.notify("change",this._color)}),{passive:!1}),s.addEventListener("change",(e=>{this._color[t]=parseInt(s.value),this._color[t]=y(this._color[t],0,255),this.render(),this.notify("change",this._color)}))}}set(t){this._color.equals(t)||(this._color.set(t),this.render())}get color(){return this._color}setPalette(t){const e=Math.min(this._palette.length,t.length);for(let s=0;s<e;s++){const e=this._palette[s],i=t[s];e.color.set(i),e.element.style.backgroundColor=i.css()}}};function k(t,e,s){return t<e?e:t>s?s:t}const x=class extends a{element;_outlets;_value;_blurCallback;constructor(t,e){super(),this._value=e,this._outlets={},this.element=c('\n      <div class="size-selector" name="root" tabindex="-1">\n        <ul>\n          <li class="row-preview"><div class="preview" name="preview"></div></li>\n          <li><span>太さ: </span><input type="range" name="slider" min="1" max="20"><input type="number" name="field" min="1" max="20"></li>\n        </ul>\n      </div>\n    ',this,this._outlets),t.appendChild(this.element),this._blurCallback=t=>{(function(t,e){for(;null!=t;){if(t==e)return!0;t=t.parentElement}return!1})(t.target,this.element)||this.close()},this.init(),this.render()}render(){const t=this._outlets.slider,e=this._outlets.field,s=this._value.toString();t.value=s,e.value=s,this._outlets.preview.style.height=`${this._value}px`}open(t,e){const s=this.element;s.style.left=`${t}px`,s.style.top=`${e}px`,s.style.display="block",s.focus(),u(s),window.addEventListener("focusin",this._blurCallback)}close(){this._outlets.root.style.display="none",window.removeEventListener("focusin",this._blurCallback)}init(){this._outlets.root.addEventListener("keydown",(t=>{}));for(const t of["slider","field"]){const e=this._outlets[t];e.addEventListener("input",(t=>{this._value=parseInt(e.value),this._value=k(this._value,1,20),this.render()})),e.addEventListener("wheel",(t=>{t.preventDefault(),this._value+=t.deltaY>0?-1:1,this._value=k(this._value,1,20),this.render(),this.notify("change",this._value)}),{passive:!1}),e.addEventListener("change",(t=>{this._value=parseInt(e.value),this._value=k(this._value,1,20),this.render(),this.notify("change",this._value)}))}}set value(t){this._value!=t&&(this._value=t,this.render())}get value(){return this._value}},S=class{_element;constructor(){this._element=document.createElement("div"),this._element.className="dt-selector"}select(t,e,s,i){null==this._element.parentElement&&document.body.appendChild(this._element),this._element.style.left=`${t}px`,this._element.style.top=`${e}px`,this._element.style.width=s-t+"px",this._element.style.height=i-e+"px"}close(){this._element.parentElement?.removeChild(this._element)}},z=[new o(128,0,0),new o(139,22,21),new o(150,45,43),new o(161,67,64),new o(173,90,86),new o(184,112,107),new o(195,134,128),new o(207,157,150),new o(218,179,171),new o(229,202,193),new o(240,224,214),new o(255,255,238),new o(120,153,34),new o(0,64,224),new o(255,255,255),new o(0,0,0)],E={width:344,height:135,penSize:4,eraserSize:4,foreColor:new o(128,0,0),backgroundColor:new o(240,224,214)};class T{penMode=new w("pen");penSize=new w(4);eraserSize=new w(4);foreColor=new b(128,0,0);backgroundColor=new b(240,224,214)}class P{_outlets;_canvas;_state;_paletteForeColor;_paletteBackgroundColor;_palettePenSize;_root;_window;_keyDownTime=new Map;constructor(){this._state=new T,this._outlets={},this._root=c('<div class="disco-tegaki root" data-on-keydown="onKeydown" data-on-keyup="onKeyup" data-on-blur="onBlur">\r\n<div class="window" name="window" tabindex="-1">\r\n  <section class="area-head">\r\n    <div class="tools">\r\n      <button name="tool-new" data-on-click="onClickNew"><img src="[asset/tool-new.png]"></button>\r\n      <button name="tool-save" data-on-click="onClickSave"><img src="[asset/tool-save.png]"></button>\r\n      <button name="tool-save" class="separator"><img src="[asset/separator.png]"></button>\r\n\r\n      <button name="tool-zoom-in" data-on-click="onClickZoomIn"><img src="[asset/tool-zoom-in.png]"></button>\r\n      <button name="tool-zoom-out" data-on-click="onClickZoomOut"><img src="[asset/tool-zoom-out.png]"></button>\r\n      <button name="tool-flip" data-on-click="onClickFlip"><img src="[asset/tool-flip.png]"></button>\r\n      <button name="tool-save" class="separator"><img src="[asset/separator.png]"></button>\r\n      \r\n      <button name="tool-fill" data-on-click="onClickFill"><img src="[asset/tool-fill.png]"></button>\r\n      <button name="tool-clear" data-on-click="onClickClear"><img src="[asset/tool-clear.png]"></button>\r\n      <button name="tool-save" class="separator"><img src="[asset/separator.png]"></button>\r\n    </div>\r\n    <div name="titlebar" class="title">手書き v1.1.0</div>\r\n    <button name="button-close" class="button-close" data-on-click="onClickClose">×</button>\r\n  </section>\r\n  <section class="area-main">\r\n    <div class="area-draw" name="area-draw">\r\n    </div>\r\n    <div class="area-tools">\r\n      \r\n      <div class="color-cell"  name="backgroundColor" data-on-click="onClickBackgroundColor"></div>\r\n      <div class="tools">\r\n        <button name="tool-pen" data-on-click="onClickPen"><img name="icon-pen" src="[asset/tool-pen-deactive.png]"></button>\r\n        <button name="tool-fore-color" data-on-click="onClickForeColor"><div class="color-cell" name="foreColor"></div></button>\r\n\r\n        <button name="tool-eraser" data-on-click="onClickEraser"><img name="icon-eraser" src="[asset/tool-eraser-deactive.png]"></button>\r\n        <button name="tool-background-color" data-on-click="onClickBackgroundColor"><div class="color-cell" name="backgroundColor"></div></button>\r\n\r\n        <button name="tool-size"  data-on-click="onClickPenSize"><img src="[asset/tool-size.png]"></button>\r\n        <button name="tool-size-value" data-on-click="onClickPenSize">4</button>\r\n\r\n        <button name="tool-spoit" data-on-click="onClickSpoit"><img name="icon-spoit" src="[asset/tool-spoit-deactive.png]"></button>\r\n\r\n        <button class="spacer"></button>\r\n\r\n        <button name="tool-undo" data-on-click="onClickUndo"><img src="[asset/tool-undo.png]"></button>\r\n        <button name="tool-redo" data-on-click="onClickRedo"><img src="[asset/tool-redo.png]"></button>\r\n      </div>\r\n    </div>\r\n  </section>\r\n  <section class="area-bottom">\r\n    <button class="button-copy" data-on-click="onClickCopy">コピー</button>\r\n    <div class="status" name="status"></div>\r\n  </section>\r\n  <div name="resize" class="area-resize"></div>\r\n</div>\r\n\r\n</div>',this,this._outlets),this._window=this._outlets.window,this._canvas=new m({width:344,height:135,foreColor:new o(128,0,0),backgroundColor:new o(240,224,214)}),this._outlets["area-draw"].appendChild(this._canvas.canvas),h?(c('<div class="disco-tegaki button-open" name="button-open"><button data-on-click="onClickOpen">手書き</button></div>',this,this._outlets),document.body.appendChild(this._outlets["button-open"])):(this._root.setAttribute("tabindex","-1"),this._root.style.width="100%",this._root.style.height="100%",this._outlets["button-close"].style.display="none"),document.body.appendChild(this._root),this._paletteForeColor=new C(this._root),this._paletteForeColor.setPalette(z),this._paletteBackgroundColor=new C(this._root),this._paletteBackgroundColor.setPalette(z),this._palettePenSize=new x(this._root,this._state.penSize.value),this.resetStatus(),this.init(),this.bind()}init(){const t=this._window;let e=null;{let s={x:0,y:0},i={x:0,y:0};const n=this._outlets.titlebar;n.innerText="手書き v1.1.1",n.addEventListener("pointerdown",(o=>{if(null!=e)return;e=o.pointerId,n.setPointerCapture(e);const a=t.getBoundingClientRect();s.x=a.x,s.y=a.y,i.x=o.clientX-a.x,i.y=o.clientY-a.y})),n.addEventListener("pointermove",(s=>{if(s.pointerId!=e)return;const n=s.clientX-i.x,o=s.clientY-i.y;t.style.left=`${n}px`,t.style.top=`${o}px`,this.adjustWindow()})),n.addEventListener("pointerup",(t=>{e==t.pointerId&&(n.setPointerCapture(e),e=null)})),n.addEventListener("pointercancel",(t=>{null!=e&&n.setPointerCapture(e),e=null}))}{const s=this._outlets.resize;let i=null,n=t.getBoundingClientRect(),o={x:0,y:0};s.addEventListener("pointerdown",(a=>{null==e&&(e=a.pointerId,s.setPointerCapture(e),n=t.getBoundingClientRect(),o.x=a.clientX-n.right,o.y=a.clientY-n.bottom,i=new S,i.select(n.left,n.top,n.right,n.bottom))})),s.addEventListener("pointermove",(t=>{if(t.pointerId!=e)return;let s=r(t.clientX-o.x,0,window.innerWidth),a=r(t.clientY-o.y,0,window.innerHeight),h=s-n.right,l=a-n.bottom,c=0|Math.max(this._canvas.width+h/this._canvas.scale,344),d=0|Math.max(this._canvas.height+l/this._canvas.scale,135);h=(c-this._canvas.width)*this._canvas.scale,l=(d-this._canvas.height)*this._canvas.scale,i?.select(n.x,n.y,n.right+h,n.bottom+l),this.showStatus(`w${this._canvas.width}:h${this._canvas.height} → w${c}:h${d}`)})),s.addEventListener("pointerup",(t=>{e==t.pointerId&&(s.setPointerCapture(e),e=null);let a=r(t.clientX-o.x,0,window.innerWidth),h=r(t.clientY-o.y,0,window.innerHeight),l=a-n.right,c=h-n.bottom,d=0|Math.max(this._canvas.width+l/this._canvas.scale,344),u=0|Math.max(this._canvas.height+c/this._canvas.scale,135);d==this._canvas.width&&u==this._canvas.height||this._canvas.resize(d,u),this.resetStatus(),i?.close()})),s.addEventListener("pointercancel",(t=>{null!=e&&s.setPointerCapture(e),e=null,this.resetStatus(),i?.close()}))}window.addEventListener("resize",(t=>{this.adjustWindow()}))}bind(){this._state.penMode.addObserver(this,"change",(t=>{for(const e of["pen","eraser"]){const s=t==e?"active":"deactive";this._outlets[`icon-${e}`].src=l(`asset/tool-${e}-${s}.png`)}this.onUpdateToolSize(),this._canvas.state.penMode=t})),this._state.penMode.sync(),this._state.penSize.addObserver(this,"change",(t=>{this._canvas.state.penSize=t,this.onUpdateToolSize()})),this._state.penSize.sync(),this._state.eraserSize.addObserver(this,"change",(t=>{this._canvas.state.eraserSize=t,this.onUpdateToolSize()})),this._state.eraserSize.sync(),this._state.foreColor.addObserver(this,"change",(t=>{this._outlets.foreColor.style.backgroundColor=t.css(),this._canvas.state.foreColor.set(t),this._paletteForeColor.set(t)})),this._state.backgroundColor.addObserver(this,"change",(t=>{this._outlets.backgroundColor.style.backgroundColor=t.css(),this._canvas.state.backgroundColor.set(t),this._paletteBackgroundColor.set(t)})),this._state.foreColor.sync(),this._state.backgroundColor.sync(),this._paletteForeColor.addObserver(this,"change",(t=>{this._state.foreColor.value=t})),this._paletteBackgroundColor.addObserver(this,"change",(t=>{this._state.backgroundColor.value=t})),this._palettePenSize.addObserver(this,"change",(t=>{"pen"==this._state.penMode.value?this._state.penSize.value=t:this._state.eraserSize.value=t})),this._canvas.addObserver(this,"size-changed",(()=>{this.resetStatus()})),this._canvas.addObserver(this,"change-sub-tool",(t=>{const e="spoit"==t?"active":"deactive";this._outlets["icon-spoit"].src=l(`asset/tool-spoit-${e}.png`)})),this._canvas.addObserver(this,"update-history",this.updateUndoRedoIcon),this.updateUndoRedoIcon(),this._canvas.addObserver(this,"spoit",(t=>{"pen"==t.tool?this._state.foreColor.value=t.color:this._state.backgroundColor.value=t.color}))}updateUndoRedoIcon(){0==this._canvas.undoLength?this._outlets["tool-undo"].setAttribute("disabled",""):this._outlets["tool-undo"].removeAttribute("disabled"),0==this._canvas.redoLength?this._outlets["tool-redo"].setAttribute("disabled",""):this._outlets["tool-redo"].removeAttribute("disabled")}onUpdateToolSize(){let t;t="pen"==this._state.penMode.value?this._state.penSize.value:this._state.eraserSize.value,this._outlets["tool-size-value"].innerText=t.toString(),this._palettePenSize.value=t}_resetStatusTimer=0;showStatus(t,e=3e3){this._outlets.status.innerText=t,clearTimeout(this._resetStatusTimer),this._resetStatusTimer=window.setTimeout((()=>{this.resetStatus()}),e)}defaultStatusText(){return`w${this._canvas.width}:h${this._canvas.height}　倍率x${this._canvas.scale.toPrecision(2)}`}resetStatus(){clearTimeout(this._resetStatusTimer),this._outlets.status.innerText=this.defaultStatusText()}resetCanvas(){this._state.foreColor.value=E.foreColor,this._state.backgroundColor.value=E.backgroundColor,this._state.penSize.value=E.penSize,this._state.eraserSize.value=E.eraserSize,this._state.penMode.value="pen",this._canvas.resize(E.width,E.height),this._canvas.clear(!1)}open(t,e){const s=this._window;s.style.display="block",void 0!==t&&void 0!==e||(t=document.body.clientWidth/2-s.clientWidth/2,e=document.body.clientHeight/2-s.clientHeight/2),s.style.left=`${t}px`,s.style.top=`${e}px`,s.focus()}onClickNew(t){this.resetCanvas()}onClickSave(t){this._canvas.download()}onClickZoomIn(t){const e=this.maxCanvasScale();this._canvas.scale>=e||this._changeScale(Math.min(this._canvas.scale+.5,e))}onClickZoomOut(t){this._canvas.scale<=1||this._changeScale(Math.max(this._canvas.scale-.5,1))}_changeScale(t){this._canvas.scale,this._canvas.scale=t,this.adjustWindow(),this.resetStatus()}onClickOpen(t){const e=this._window;"block"!=e.style.display?this.open():e.style.display="none"}onClickClose(t){this._window.style.display="none"}onClickPen(t){this._state.penMode.value="pen"}onClickEraser(t){this._state.penMode.value="eraser"}onClickPenSize(t){this._palettePenSize.open(t.clientX,t.clientY)}onClickForeColor(t){this._paletteForeColor.open(t.clientX,t.clientY)}onClickBackgroundColor(t){this._paletteBackgroundColor.open(t.clientX,t.clientY)}onClickSpoit(t){"spoit"==this._canvas.state.subTool?this._canvas.state.subTool="none":this._canvas.state.subTool="spoit"}onClickClear(t){this._canvas.clear()}onClickFill(t){this._canvas.fill()}onClickFlip(t){this._canvas.flip()}async onClickCopy(t){await this._canvas.copyToClipboard(),this.showStatus("クリップボードにコピーしました")}onClickUndo(t){this._canvas.undo()}onClickRedo(t){this._canvas.redo()}onBlur(t){this._canvas.state.subTool="none",this._keyDownTime.clear()}onKeydown(t){t.stopPropagation(),t.repeat||(t.ctrlKey?"z"==t.key?this._canvas.undo():"y"==t.key?this._canvas.redo():"c"==t.key&&this.onClickCopy():"e"==t.key&&"eraser"!=this._state.penMode.value?(this._state.penMode.value="eraser",this._keyDownTime.set("e",Date.now())):"n"==t.key&&"pen"!=this._state.penMode.value?(this._state.penMode.value="pen",this._keyDownTime.set("n",Date.now())):"Alt"==t.key&&(t.preventDefault(),this._canvas.state.subTool="spoit"))}onKeyup(t){if("Alt"==t.key&&"spoit"==this._canvas.state.subTool&&(this._canvas.state.subTool="none"),"e"==t.key){const t=this._keyDownTime.get("e");if(this._keyDownTime.delete("e"),void 0===t||Date.now()-t<500)return;this._state.penMode.value="pen"}else if("n"==t.key){const t=this._keyDownTime.get("n");if(this._keyDownTime.delete("n"),void 0===t||Date.now()-t<500)return;this._state.penMode.value="eraser"}}adjustWindow(){const t=this.maxCanvasScale();this._canvas.scale>t&&(this._canvas.scale=t);const e=this._window,s=e.getBoundingClientRect();s.x<0?e.style.left="0":s.right>window.innerWidth&&(e.style.left=window.innerWidth-e.clientWidth+"px"),s.y<0?e.style.top="0":s.bottom>window.innerHeight&&(e.style.top=window.innerHeight-e.clientHeight+"px")}maxCanvasScale(){return Math.min((window.innerWidth-84)/this._canvas.width,(window.innerHeight-73)/this._canvas.height)}}if(!h||location.href.startsWith("https://discord.com/app")||location.href.startsWith("https://discord.com/channels")){const t=new P;h||t.open(0,0),console.log("[Discord Tegaki]launched")}})();